# Pierces the ADO npm feed cache in order to pull in new versions published to
# the public npm feed.
#
# Expects the last git commit to contain all package.json files for packages
# that have been published.

parameters:
  - name: adoNpmFeedPat
    type: string
    default: "PROVIDE AN ADO NPM FEED PAT THAT HAS CONTRIBUTOR PERMISSION"
  - name: adoOrgBaseUrl
    type: string
    default: "https://pkgs.dev.azure.com/domoreexp"
  - name: adoNpmFeedName
    type: string

steps:
  - bash: |
      pkgFilename="packages/apollo-react-relay-duct-tape/package.json"
        pkgName=`cat $pkgFilename | jq -r '.name'`
        pkgVersion=`cat $pkgFilename | jq -r '.version'`
        pkgBasename=`echo $pkgName | cut -d "/" -f 2`
        echo "Piercing ADO npm feed cache for $pkgName@$pkgVersion"
        curl -Ivu $(adoNpmFeedPat) $(adoOrgBaseUrl)/_apis/packaging/feeds/$(adoNpmFeedName)/npm/packages/$pkgName/versions/$pkgVersion/content || true
        curl -o /dev/null -vu $(adoNpmFeedPat) $(adoOrgBaseUrl)/_packaging/$(adoNpmFeedName)/npm/registry/$pkgName/-/$pkgBasename-$pkgVersion.tgz || true
    displayName: "Pierce ADO NPM feed cache"
